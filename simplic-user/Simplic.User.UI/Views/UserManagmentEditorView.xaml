<simplic:DefaultRibbonWindow x:Class="Simplic.User.UI.UserManagmentEditorView"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:simplic="http://schemas.simplic-systems.com/2016/xaml/presentation"
        xmlns:telerik="http://schemas.telerik.com/2008/xaml/presentation"
        xmlns:converters="clr-namespace:Simplic.User.UI"
        xmlns:uc="clr-namespace:Simplic.User.UI"
        xmlns:vm="clr-namespace:Simplic.User.UI"
        xmlns:utls="clr-namespace:Simplic.User.UI"
        xmlns:dlgs="clr-namespace:Simplic.User.UI"
        xmlns:local="clr-namespace:Simplic.User.UI"
        xmlns:i="clr-namespace:System.Windows.Interactivity;assembly=System.Windows.Interactivity"
        dlgs:DialogBehavior.DialogViewModels="{Binding Dialogs}"
        Title="Groups and users management" WindowState="Maximized" LayoutContext="Win_UserManagement">
    <simplic:DefaultRibbonWindow.Resources>
        <local:UserDetailsView x:Key="{x:Type vm:UserDetailsViewModel}" x:Shared="False" />
        <local:GroupDetailsView x:Key="{x:Type vm:GroupDetailsViewModel}" x:Shared="False" />
        <local:OrganizationDetailsView x:Key="{x:Type vm:OrganizationDetailsViewModel}" x:Shared="False" />
        <converters:GroupsToLabelConverter x:Key="GroupsToLabelConverter" />
        <converters:OrganizationsToLabelConverter x:Key="OrganizationsToLabelConverter" />
        <converters:SelectedUserIsNullConverter x:Key="SelectedUserIsNullConverter" />
        <converters:UserToListViewItemConverter x:Key="UserToListViewItemConverter" />
        <converters:BoolToVisibilityConverter x:Key="TrueVisibilityConverter" VisibilityForTrue="Visible" VisibilityForFalse="Collapsed" />
        <converters:BoolToVisibilityConverter x:Key="FalseVisibilityConverter" VisibilityForTrue="Collapsed" VisibilityForFalse="Visible" />
    </simplic:DefaultRibbonWindow.Resources>
    <Grid>
        <Grid.Resources>
            <ResourceDictionary>
                <ResourceDictionary.MergedDictionaries>
                    <ResourceDictionary Source="..\Resources\Telerik.Windows.Controls.GridView.xaml" />
                </ResourceDictionary.MergedDictionaries>
            </ResourceDictionary>
        </Grid.Resources>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <simplic:KeyboardController Grid.Row="0" x:Name="keyboardController" IsActive="True" AutomaticActivationOnLoad="True" Margin="5">
            <simplic:RibbonContextController x:Name="mainRibbonContextController">
                <simplic:RibbonContextController.RadRibbonContextTab>
                    <telerik:RadRibbonTab x:Name="radRibbonTab" Header="General">
                        <telerik:RadRibbonGroup Header="General">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <telerik:RadRibbonButton Command="{Binding Path=AddUserCommand}" Grid.Column="0" Margin="0,0,5,0"
                                                         LargeImage="{simplic:Icon Name=usermanagement_add_user_32x}" Text="Add user" Size="Large"/>

                                <StackPanel Grid.Column="1" Orientation="Horizontal" IsEnabled="{Binding Path=SelectedUser, Converter={StaticResource SelectedUserIsNullConverter}}">
                                    <telerik:RadRibbonButton Command="{Binding Path=OpenSelectedUserDetailsCommand}" LargeImage="{simplic:Icon Name=usermanagement_edit_user_32x}" Text="Edit user" Size="Large" />
                                    <telerik:RadRibbonButton Margin="5,0,0,0" Command="{Binding Path=DeleteSelectedUserCommand}" LargeImage="{simplic:Icon Name=usermanagement_remove_user_32x}" Text="Remove user" Size="Large" />
                                </StackPanel>

                                <telerik:RadRibbonToggleButton LargeImage="{simplic:Icon Name=usermanagement_change_view_32x}" Text="Change view" Size="Large"
                                                           Margin="5,0,0,0" Name="_changeBtn" Grid.Column="2"
                                                           Command="{Binding Path=SkipSelectedUserCommand}"
                                                           Visibility="{Binding Path=IsGroupsSelected, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type local:UserManagmentEditorView}}, Converter={StaticResource TrueVisibilityConverter}}"/>

                                <telerik:RadRibbonToggleButton LargeImage="{simplic:Icon Name=usermanagement_change_view_32x}" Text="Change view" Size="Large"
                                                           Margin="5,0,0,0" Name="_changeBtn2" Grid.Column="2"
                                                           Command="{Binding Path=SkipSelectedUserCommand}"
                                                           Visibility="{Binding Path=IsGroupsSelected, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type local:UserManagmentEditorView}}, Converter={StaticResource FalseVisibilityConverter}}"/>
                            </Grid>
                        </telerik:RadRibbonGroup>
                    </telerik:RadRibbonTab>
                </simplic:RibbonContextController.RadRibbonContextTab>
            </simplic:RibbonContextController>
        </simplic:KeyboardController>

        <TabControl Grid.Row="1">
            <TabItem Header="User and groups" Name="usersItem" IsSelected="{Binding Path=IsGroupsSelected, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type local:UserManagmentEditorView}}, Mode=OneWayToSource}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <simplic:CursorGridViewControl Grid.Row="1" ItemsSource="{Binding Path=Users}" AutoGenerateColumns="False" GridLinesVisibility="Both"
                             Visibility="{Binding Path=IsChecked, ElementName=_changeBtn, Converter={StaticResource FalseVisibilityConverter}}"
                             ShowGroupPanel="False" RowIndicatorVisibility="Collapsed"
                             SelectedItem="{Binding Path=SelectedUser, Mode=TwoWay}">
                        <simplic:CursorGridViewControl.Columns>
                            <telerik:GridViewSelectColumn/>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=UserName}" Header="User Name" IsReadOnly="True">
                                <telerik:GridViewDataColumn.FilteringControl>
                                    <uc:StringComparisonFilterControl LabelText="User name: "/>
                                </telerik:GridViewDataColumn.FilteringControl>
                            </telerik:GridViewDataColumn>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=FirstName}" Header="First Name" IsReadOnly="True">
                                <telerik:GridViewDataColumn.FilteringControl>
                                    <uc:StringComparisonFilterControl LabelText="First name: "/>
                                </telerik:GridViewDataColumn.FilteringControl>
                            </telerik:GridViewDataColumn>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=LastName}" Header="Last Name" IsReadOnly="True">
                                <telerik:GridViewDataColumn.FilteringControl>
                                    <uc:StringComparisonFilterControl LabelText="Last name: "/>
                                </telerik:GridViewDataColumn.FilteringControl>
                            </telerik:GridViewDataColumn>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=Email}" Header="Email" IsReadOnly="True">
                                <telerik:GridViewDataColumn.FilteringControl>
                                    <uc:StringComparisonFilterControl LabelText="Email: "/>
                                </telerik:GridViewDataColumn.FilteringControl>
                            </telerik:GridViewDataColumn>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=IsActive}" Header="Is Active" IsReadOnly="True" IsFilterable="False">
                                <telerik:GridViewDataColumn.CellTemplate>
                                    <DataTemplate>
                                        <telerik:Label Content="{Binding Path=IsActive}"/>
                                    </DataTemplate>
                                </telerik:GridViewDataColumn.CellTemplate>
                            </telerik:GridViewDataColumn>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=Phone}" Header="Phone" MinWidth="180" IsReadOnly="True">
                                <telerik:GridViewDataColumn.FilteringControl>
                                    <uc:StringComparisonFilterControl LabelText="Phone: "/>
                                </telerik:GridViewDataColumn.FilteringControl>
                            </telerik:GridViewDataColumn>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=Groups}" Header="Groups" MinWidth="250" IsFilterable="False">
                                <telerik:GridViewDataColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock TextWrapping="Wrap" Text="{Binding Path=Groups, Converter={StaticResource GroupsToLabelConverter}}"
                                       ToolTip="{Binding Path=Groups, Converter={StaticResource GroupsToLabelConverter}}"/>
                                    </DataTemplate>
                                </telerik:GridViewDataColumn.CellTemplate>
                                <telerik:GridViewDataColumn.CellEditTemplate>
                                    <DataTemplate>
                                        <uc:MultiSelectComboBox ItemsSource="{Binding Path=DataContext.Groups, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type telerik:RadGridView}}}"
                                            NoneCheckedText="None"
                                            EditCommand="{Binding Path=DataContext.EditCurrentGroupCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type telerik:RadGridView}}}"
                                            SelectionChangedCommand="{Binding Path=DataContext.GroupBindigsChangedCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type telerik:RadGridView}}}"
                                            CurrentUser="{Binding Path=DataContext, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type telerik:GridViewCell}}}"
                                            CurrentUserSubItems="{Binding Path=DataContext.Groups, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type telerik:GridViewCell}}}" />
                                    </DataTemplate>
                                </telerik:GridViewDataColumn.CellEditTemplate>
                            </telerik:GridViewDataColumn>
                        </simplic:CursorGridViewControl.Columns>
                    </simplic:CursorGridViewControl>

                    <Grid Grid.Row="1" Margin="0,10,5,5" 
                            Visibility="{Binding Path=IsChecked, ElementName=_changeBtn, Converter={StaticResource TrueVisibilityConverter}}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width=".43*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <DockPanel  Grid.Column="1" Grid.Row="0" LastChildFill="True" Margin="0,0,0,5">
                            <Label Content="Filter:" VerticalAlignment="Center" DockPanel.Dock="Left" />
                            <TextBox Height="27" Width="Auto" VerticalContentAlignment="Center" Margin="5,0,0,0" HorizontalAlignment="Stretch"
                                    Text="{Binding Path=FilterString, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        </DockPanel>

                        <Grid Grid.Column="0" Grid.Row="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <Label Grid.Column="0" Content="Managment studio groups:" />
                            <Button Grid.Column="1" Height="20" Width="20" Background="Transparent" BorderThickness="0" ToolTip="Expand all" Click="OnAllGroupsExpand">
                                <Button.Content>
                                    <Image Source="{simplic:Icon Name=usermanagement_expand_all_32x}" VerticalAlignment="Center" Width="20" Height="20" HorizontalAlignment="Center" />
                                </Button.Content>
                            </Button>
                            <Button Grid.Column="2" Margin="5,0,10,0" Height="20" Width="20" Background="Transparent" BorderThickness="0" ToolTip="Collapse all" Click="OnAllGroupsCollapse">
                                <Button.Content>
                                    <Image Source="{simplic:Icon Name=usermanagement_collapse_all_32x}" VerticalAlignment="Center" Width="20" Height="20" HorizontalAlignment="Center" />
                                </Button.Content>
                            </Button>
                        </Grid>
                        
                        <ListView Name="_lstGroups" Grid.Column="0" Grid.Row="1" ItemsSource="{Binding Path=Groups}"
                                  ScrollViewer.VerticalScrollBarVisibility="Auto" Margin="0,0,10,0"
                                  ScrollViewer.CanContentScroll="False">
                            <ListView.ItemContainerStyle>
                                <Style TargetType="{x:Type ListViewItem}">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="{x:Type ListViewItem}">
                                                <ContentPresenter />
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListView.ItemContainerStyle>
                            <ListView.ItemTemplate>
                                <DataTemplate DataType="{x:Type vm:GroupViewModel}">
                                    <Expander>
                                        <Expander.Header>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>
                                                <Label Grid.Column="0" Content="{Binding Path=Name}" Margin="3"
                                                     HorizontalAlignment="{Binding HorizontalAlignment, RelativeSource={RelativeSource AncestorType={x:Type ContentPresenter}}, Mode=OneWayToSource}"  />
                                                <Button Grid.Column="1" Height="20" Width="20" Margin="3" Background="Transparent" BorderThickness="0"
                                                    Command="{Binding Path=DataContext.EditCurrentGroupCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ListView}}}"
                                                    CommandParameter="{Binding Path=.}">
                                                    <Button.Content>
                                                        <Image Source="{simplic:Icon Name=usermanagement_edit_32x}" VerticalAlignment="Center" HorizontalAlignment="Center" Height="20" Width="20" />
                                                    </Button.Content>
                                                </Button>
                                            </Grid>
                                        </Expander.Header>
                                        <uc:ListViewWithDragAndDrop ItemsSource="{Binding Path=Users}" Margin="5" MinHeight="50">
                                            <i:Interaction.Behaviors>
                                                <utls:IgnoreMouseWheelBehavior />
                                            </i:Interaction.Behaviors>
                                            <uc:ListViewWithDragAndDrop.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal" MaxWidth="900" />
                                                </ItemsPanelTemplate>
                                            </uc:ListViewWithDragAndDrop.ItemsPanel>
                                            <uc:ListViewWithDragAndDrop.ItemContainerStyle>
                                                <Style TargetType="{x:Type ListViewItem}">
                                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                                    <Setter Property="BorderThickness" Value="0"/>
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="{x:Type ListViewItem}">
                                                                <ContentPresenter />
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Style>
                                            </uc:ListViewWithDragAndDrop.ItemContainerStyle>
                                            <uc:ListViewWithDragAndDrop.ItemTemplate>
                                                <DataTemplate DataType="{x:Type vm:UserViewModel}">
                                                    <uc:UserBox User="{Binding Path=.}" Margin="4"
                                                                EditCommand="{Binding Path=DataContext.EditCurrentUserCommand, RelativeSource={RelativeSource AncestorLevel=2, Mode=FindAncestor, AncestorType={x:Type ListView}}}"
                                                                RemoveCommand="{Binding Path=DataContext.DeleteCurrentUserCommand, RelativeSource={RelativeSource AncestorLevel=2, Mode=FindAncestor, AncestorType={x:Type ListView}}}"/>
                                                </DataTemplate>
                                            </uc:ListViewWithDragAndDrop.ItemTemplate>
                                        </uc:ListViewWithDragAndDrop>
                                    </Expander>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>

                        <uc:ListViewWithDragAndDrop Grid.Column="1" Grid.Row="1" ItemsSource="{Binding Path=FilteredUsers}">
                            <uc:ListViewWithDragAndDrop.ItemContainerStyle>
                                <Style TargetType="{x:Type ListViewItem}">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                </Style>
                            </uc:ListViewWithDragAndDrop.ItemContainerStyle>
                            <uc:ListViewWithDragAndDrop.ItemTemplate>
                                <DataTemplate DataType="{x:Type vm:UserViewModel}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <Label Grid.Column="0">
                                            <Label.Content>
                                                <MultiBinding Converter="{StaticResource UserToListViewItemConverter}" Mode="OneWay">
                                                    <Binding Path="FirstName" />
                                                    <Binding Path="LastName" />
                                                    <Binding Path="UserName" />
                                                    <Binding Path="Email" />
                                                </MultiBinding>
                                            </Label.Content>
                                        </Label>
                                        <Button Height="20" Width="20" Grid.Column="1" BorderBrush="Transparent" Background="Transparent"
                                            Command="{Binding Path=DataContext.EditCurrentUserCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ListView}}}"
                                            CommandParameter="{Binding Path=.}">
                                            <Image Source="{simplic:Icon Name=usermanagement_edit_user_32x}" VerticalAlignment="Center" HorizontalAlignment="Center" Height="16" Width="16" />
                                        </Button>
                                        <Button Height="20" Width="20" Grid.Column="2" BorderBrush="Transparent" Background="Transparent"
                                            Command="{Binding Path=DataContext.DeleteCurrentUserCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ListView}}}"
                                            CommandParameter="{Binding Path=.}">
                                            <Image Source="{simplic:Icon Name=usermanagement_remove_user_32x}" VerticalAlignment="Center" HorizontalAlignment="Center" Height="17" Width="17" />
                                        </Button>
                                    </Grid>
                                </DataTemplate>
                            </uc:ListViewWithDragAndDrop.ItemTemplate>
                        </uc:ListViewWithDragAndDrop>
                    </Grid>
                </Grid>
            </TabItem>
            <TabItem Header="Tenants" Name="tenantItem">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <simplic:CursorGridViewControl Grid.Row="1" ItemsSource="{Binding Path=Users}" AutoGenerateColumns="False" GridLinesVisibility="Both"
                             Visibility="{Binding Path=IsChecked, ElementName=_changeBtn2, Converter={StaticResource FalseVisibilityConverter}}"
                             ShowGroupPanel="False" RowIndicatorVisibility="Collapsed"
                             SelectedItem="{Binding Path=SelectedUser, Mode=TwoWay}">
                        <simplic:CursorGridViewControl.Columns>
                            <telerik:GridViewSelectColumn/>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=UserName}" Header="User Name" IsReadOnly="True">
                                <telerik:GridViewDataColumn.FilteringControl>
                                    <uc:StringComparisonFilterControl LabelText="User name: "/>
                                </telerik:GridViewDataColumn.FilteringControl>
                            </telerik:GridViewDataColumn>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=FirstName}" Header="First Name" IsReadOnly="True">
                                <telerik:GridViewDataColumn.FilteringControl>
                                    <uc:StringComparisonFilterControl LabelText="First name: "/>
                                </telerik:GridViewDataColumn.FilteringControl>
                            </telerik:GridViewDataColumn>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=LastName}" Header="Last Name" IsReadOnly="True">
                                <telerik:GridViewDataColumn.FilteringControl>
                                    <uc:StringComparisonFilterControl LabelText="Last name: "/>
                                </telerik:GridViewDataColumn.FilteringControl>
                            </telerik:GridViewDataColumn>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=Email}" Header="Email" IsReadOnly="True">
                                <telerik:GridViewDataColumn.FilteringControl>
                                    <uc:StringComparisonFilterControl LabelText="Email: "/>
                                </telerik:GridViewDataColumn.FilteringControl>
                            </telerik:GridViewDataColumn>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=IsActive}" Header="Is Active" IsReadOnly="True" IsFilterable="False">
                                <telerik:GridViewDataColumn.CellTemplate>
                                    <DataTemplate>
                                        <telerik:Label Content="{Binding Path=IsActive}"/>
                                    </DataTemplate>
                                </telerik:GridViewDataColumn.CellTemplate>
                            </telerik:GridViewDataColumn>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=Phone}" Header="Phone" MinWidth="180" IsReadOnly="True">
                                <telerik:GridViewDataColumn.FilteringControl>
                                    <uc:StringComparisonFilterControl LabelText="Phone: "/>
                                </telerik:GridViewDataColumn.FilteringControl>
                            </telerik:GridViewDataColumn>
                            <telerik:GridViewDataColumn DataMemberBinding="{Binding Path=Organizations}" Header="Tenants" MinWidth="250" IsFilterable="False">
                                <telerik:GridViewDataColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock TextWrapping="Wrap" Text="{Binding Path=Organizations, Converter={StaticResource OrganizationsToLabelConverter}}"
                                            ToolTip="{Binding Path=Organizations, Converter={StaticResource OrganizationsToLabelConverter}}"/>
                                    </DataTemplate>
                                </telerik:GridViewDataColumn.CellTemplate>
                                <telerik:GridViewDataColumn.CellEditTemplate>
                                    <DataTemplate>
                                        <uc:MultiSelectComboBox ItemsSource="{Binding Path=DataContext.Organizations, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type telerik:RadGridView}}}"
                                            NoneCheckedText="None"
                                            EditCommand="{Binding Path=DataContext.EditCurrentOrganizationCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type telerik:RadGridView}}}"
                                            SelectionChangedCommand="{Binding Path=DataContext.OrganizationBindigsChangedCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type telerik:RadGridView}}}"
                                            CurrentUser="{Binding Path=DataContext, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type telerik:GridViewCell}}}"
                                            CurrentUserSubItems="{Binding Path=DataContext.Organizations, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type telerik:GridViewCell}}}"/>
                                    </DataTemplate>
                                </telerik:GridViewDataColumn.CellEditTemplate>
                            </telerik:GridViewDataColumn>
                        </simplic:CursorGridViewControl.Columns>
                    </simplic:CursorGridViewControl>

                    <Grid Grid.Row="1" Margin="0,10,5,5" 
                            Visibility="{Binding Path=IsChecked, ElementName=_changeBtn2, Converter={StaticResource TrueVisibilityConverter}}">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width=".43*"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <DockPanel  Grid.Column="1" Grid.Row="0" LastChildFill="True" Margin="0,0,0,5">
                            <Label Content="Filter:" VerticalAlignment="Center" DockPanel.Dock="Left" />
                            <TextBox Height="27" Width="Auto" VerticalContentAlignment="Center" Margin="5,0,0,0" HorizontalAlignment="Stretch"
                                    Text="{Binding Path=FilterString2, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                        </DockPanel>

                        <Grid Grid.Column="0" Grid.Row="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>
                            <Label Content="Managment studio groups:" Grid.Column="0" />
                            <Button Grid.Column="1" Height="20" Width="20" Background="Transparent" BorderThickness="0" ToolTip="Expand all" Click="OnAllOrganizationsExpand">
                                <Button.Content>
                                    <Image Source="{simplic:Icon Name=usermanagement_expand_all_32x}" VerticalAlignment="Center" Width="20" Height="20" HorizontalAlignment="Center" />
                                </Button.Content>
                            </Button>
                            <Button Grid.Column="2" Margin="5,0,10,0" Height="20" Width="20" Background="Transparent" BorderThickness="0" ToolTip="Collapse all" Click="OnAllOrganizationsCollapse">
                                <Button.Content>
                                    <Image Source="{simplic:Icon Name=usermanagement_collapse_all_32x}" VerticalAlignment="Center" Width="20" Height="20" HorizontalAlignment="Center" />
                                </Button.Content>
                            </Button>
                        </Grid>                        
                        <ListView Name="_lstOrganizations" Grid.Column="0" Grid.Row="1" ItemsSource="{Binding Path=Organizations}"
                                  ScrollViewer.VerticalScrollBarVisibility="Auto" Margin="0,0,10,0"
                                  ScrollViewer.CanContentScroll="False">
                            <ListView.ItemContainerStyle>
                                <Style TargetType="{x:Type ListViewItem}">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="{x:Type ListViewItem}">
                                                <ContentPresenter />
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListView.ItemContainerStyle>
                            <ListView.ItemTemplate>
                                <DataTemplate DataType="{x:Type vm:OrganizationViewModel}">
                                    <Expander>
                                        <Expander.Header>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*" />
                                                    <ColumnDefinition Width="Auto" />
                                                </Grid.ColumnDefinitions>
                                                <Label Grid.Column="0" Content="{Binding Path=Name}" Margin="3"
                                                     HorizontalAlignment="{Binding HorizontalAlignment, RelativeSource={RelativeSource AncestorType={x:Type ContentPresenter}}, Mode=OneWayToSource}"  />
                                                <Button Grid.Column="1" Height="20" Width="20" Margin="3" Background="Transparent" BorderThickness="0"
                                                    Command="{Binding Path=DataContext.EditCurrentOrganizationCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ListView}}}"
                                                    CommandParameter="{Binding Path=.}">
                                                    <Button.Content>
                                                        <Image Source="{simplic:Icon Name=usermanagement_edit_32x}" VerticalAlignment="Center" HorizontalAlignment="Center" Height="20" Width="20" />
                                                    </Button.Content>
                                                </Button>
                                            </Grid>
                                        </Expander.Header>
                                        <uc:ListViewWithDragAndDrop ItemsSource="{Binding Path=Users}" Margin="5" MinHeight="50">
                                            <i:Interaction.Behaviors>
                                                <utls:IgnoreMouseWheelBehavior />
                                            </i:Interaction.Behaviors>
                                            <uc:ListViewWithDragAndDrop.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal" MaxWidth="900" />
                                                </ItemsPanelTemplate>
                                            </uc:ListViewWithDragAndDrop.ItemsPanel>
                                            <uc:ListViewWithDragAndDrop.ItemContainerStyle>
                                                <Style TargetType="{x:Type ListViewItem}">
                                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                                    <Setter Property="BorderThickness" Value="0"/>
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="{x:Type ListViewItem}">
                                                                <ContentPresenter />
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Style>
                                            </uc:ListViewWithDragAndDrop.ItemContainerStyle>
                                            <uc:ListViewWithDragAndDrop.ItemTemplate>
                                                <DataTemplate DataType="{x:Type vm:UserViewModel}">
                                                    <uc:UserBox User="{Binding Path=.}" Margin="4"
                                                                EditCommand="{Binding Path=DataContext.EditCurrentUserCommand, RelativeSource={RelativeSource AncestorLevel=2, Mode=FindAncestor, AncestorType={x:Type ListView}}}"
                                                                RemoveCommand="{Binding Path=DataContext.DeleteCurrentUserCommand, RelativeSource={RelativeSource AncestorLevel=2, Mode=FindAncestor, AncestorType={x:Type ListView}}}"/>
                                                </DataTemplate>
                                            </uc:ListViewWithDragAndDrop.ItemTemplate>
                                        </uc:ListViewWithDragAndDrop>
                                    </Expander>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>

                        <uc:ListViewWithDragAndDrop Grid.Column="1" Grid.Row="1" ItemsSource="{Binding Path=FilteredUsers2}">
                            <uc:ListViewWithDragAndDrop.ItemContainerStyle>
                                <Style TargetType="{x:Type ListViewItem}">
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                </Style>
                            </uc:ListViewWithDragAndDrop.ItemContainerStyle>
                            <uc:ListViewWithDragAndDrop.ItemTemplate>
                                <DataTemplate DataType="{x:Type vm:UserViewModel}">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="Auto" />
                                            <ColumnDefinition Width="Auto" />
                                        </Grid.ColumnDefinitions>
                                        <Label Grid.Column="0">
                                            <Label.Content>
                                                <MultiBinding Converter="{StaticResource UserToListViewItemConverter}" Mode="OneWay">
                                                    <Binding Path="FirstName" />
                                                    <Binding Path="LastName" />
                                                    <Binding Path="UserName" />
                                                    <Binding Path="Email" />
                                                </MultiBinding>
                                            </Label.Content>
                                        </Label>
                                        <Button Height="20" Width="20" Grid.Column="1" BorderBrush="Transparent" Background="Transparent"
                                            Command="{Binding Path=DataContext.EditCurrentUserCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ListView}}}"
                                            CommandParameter="{Binding Path=.}">
                                            <Image Source="{simplic:Icon Name=usermanagement_edit_user_32x}" VerticalAlignment="Center" HorizontalAlignment="Center" Height="16" Width="16" />
                                        </Button>
                                        <Button Height="20" Width="20" Grid.Column="2" BorderBrush="Transparent" Background="Transparent"
                                            Command="{Binding Path=DataContext.DeleteCurrentUserCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type ListView}}}"
                                            CommandParameter="{Binding Path=.}">
                                            <Image Source="{simplic:Icon Name=usermanagement_remove_user_32x}" VerticalAlignment="Center" HorizontalAlignment="Center" Height="17" Width="17" />
                                        </Button>
                                    </Grid>
                                </DataTemplate>
                            </uc:ListViewWithDragAndDrop.ItemTemplate>
                        </uc:ListViewWithDragAndDrop>
                    </Grid>
                </Grid>
            </TabItem>
        </TabControl>
    </Grid>
</simplic:DefaultRibbonWindow>
